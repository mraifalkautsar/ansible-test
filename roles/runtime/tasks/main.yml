- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  changed_when: false
  become: yes

- name: Install system dependencies
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
  become: yes

- name: Add NodeSource setup script
  ansible.builtin.shell:
    cmd: "curl -fsSL {{ nodejs_setup_url }} | bash -"
    creates: /etc/apt/sources.list.d/nodesource.list
  become: yes

- name: Install Node.js
  ansible.builtin.apt:
    name: "{{ nodejs_package }}"
    state: present
  become: yes

- name: Install PM2 globally
  community.general.npm:
    name: "{{ pm2_package }}"
    global: yes
    state: present
  become: yes

# =========================
# PM2 SYSTEMD INTEGRATION
# =========================

- name: Enable PM2 startup service for app user
  ansible.builtin.command:
    cmd: pm2 startup systemd -u {{ app_user }} --hp /home/{{ app_user }}
  become: yes
  environment:
    PATH: "/usr/bin:/bin:/usr/local/bin"