---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
  changed_when: false

- name: Install dependencies
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present

- name: Add NodeSource setup script
  ansible.builtin.shell:
    cmd: "curl -fsSL {{ nodejs_setup_url }} | bash -"
    creates: /etc/apt/sources.list.d/nodesource.list
  changed_when: true

- name: Install Node.js
  ansible.builtin.apt:
    name: "{{ nodejs_package }}"
    state: present

- name: Install PM2 globally
  community.general.npm:
    name: "{{ pm2_package }}"
    global: yes
    state: present

- name: Configure PM2 to start on boot
  ansible.builtin.command:
    cmd: "pm2 startup systemd -u {{ app_user }} --hp {{ ansible_user_dir }}"
  become: yes
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/bin"
  register: pm2_startup_result
  changed_when: "'systemd' in pm2_startup_result.stdout"

- name: Save initial PM2 process list
  ansible.builtin.command:
    cmd: "pm2 save"
  become: yes
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/bin"
  when: pm2_startup_result.changed