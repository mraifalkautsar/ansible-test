- name: Create application directory
  ansible.builtin.file:
    path: "{{ app_deploy_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0755'
  become: yes

- name: Clone application repository
  ansible.builtin.git:
    repo: "{{ app_repo }}"
    dest: "{{ app_deploy_dir }}"
    version: "{{ app_repo_version }}"
    force: yes
  become: yes
  become_user: "{{ app_user }}"

- name: Template PM2 ecosystem file
  ansible.builtin.template:
    src: ecosystem.config.js.j2
    dest: "{{ app_deploy_dir }}/ecosystem.config.js"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0644'
  become: yes

- name: Install application dependencies
  community.general.npm:
    path: "{{ app_deploy_dir }}"
    production: true
  become: yes
  become_user: "{{ app_user }}"

# =========================
# PM2 APP START + PERSIST
# =========================

- name: Start or restart app with PM2
  ansible.builtin.command:
    cmd: pm2 startOrRestart ecosystem.config.js
  args:
    chdir: "{{ app_deploy_dir }}"
  become: yes
  become_user: "{{ app_user }}"

- name: Save PM2 process list for reboot
  ansible.builtin.command:
    cmd: pm2 save
  become: yes
  become_user: "{{ app_user }}"

# =========================
# SAFETY CHECK
# =========================

- name: Verify PM2 dump exists
  ansible.builtin.stat:
    path: /home/{{ app_user }}/.pm2/dump.pm2
  register: pm2_dump

- name: Fail if PM2 will not resurrect on boot
  ansible.builtin.fail:
    msg: "PM2 dump.pm2 missing â€” app WILL NOT start after reboot"
  when: not pm2_dump.stat.exists